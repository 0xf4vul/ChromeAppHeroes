var db;const BG_BASIC={DB_NAME:"sps",DB_VERSION:1,DB_STORE_NAME:"podcast",podcastIndex:0,method:{openDB:function(){var e=indexedDB.open(BG_BASIC.DB_NAME,BG_BASIC.DB_VERSION);e.onsuccess=function(e){db=this.result,BG_BASIC.M.getDB("podcast")},e.onerror=function(e){},e.onupgradeneeded=function(e){}},getDB:function(e){const s=db.transaction([BG_BASIC.DB_STORE_NAME],"readwrite").objectStore(BG_BASIC.DB_STORE_NAME).get(e);s.onerror=function(){},s.onsuccess=function(s){const o=s.target.result;if("podcast"===e&&o.searchList[BG_BASIC.podcastIndex+1]){const{title:e,url:s}=o.searchList[BG_BASIC.podcastIndex+1];loadPodcast({index:BG_BASIC.podcastIndex+1,name:e,url:s,type:"itunes"}),db.close()}}},getStoreDB:function(e){return db.transaction([BG_BASIC.DB_STORE_NAME],"readwrite").objectStore(BG_BASIC.DB_STORE_NAME)}},init:()=>{BG_BASIC.M.openDB()}};BG_BASIC.M=BG_BASIC.method;let playIndex=0,playDisAbleNum=0;const commentList={netease:"云村",xiami:"虾米",qq:"QQ",fm:"电台",song:{id:1769074224,web:"xiami"},songComment:"以上为返回给background的info信息",list:[{album:"天使与魔鬼的对话",artists:["蔡健雅"],id:27747330,name:"被驯服的象"}],listComment:"以上为搜索返回的处理后的结果，设置请求为5条",favourite:"favourite",unableCollect:"fm",lyricNotification:"lyricNotification",lyricShow:!0,whitevoice:"whitevoice",local:"local"},player=new rPlayer,loadFM=(e,s)=>{chrome.notifications.clear(commentList.lyricNotification),playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src","");const o=`http://lhttp.qingting.fm/live/${e}/64k.mp3`;document.getElementsByTagName("source")[0].src=o;let t=document.getElementsByTagName("audio")[0];t.load(),t.play().then(e=>{chrome.storage.local.set({sps_song:s,sps_web:"fm",sps_play:!0,sps_sound_url:o})}).catch(e=>{console.log("出错啦!")})},handleProgress=e=>{if(e.duration){let s=(e.currentTime/e.duration).toFixed(5);const o={progress:s=100*s+"%"};chrome.runtime.connect().postMessage(o)}},loadLocalSong=(e,s)=>{chrome.notifications.clear(commentList.lyricNotification),playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),document.getElementsByTagName("source")[0].src=e;let o=document.getElementsByTagName("audio")[0];o.loop=!0,o.load(),o.play().then(o=>{chrome.storage.local.set({sps_song:s,sps_web:"Local",sps_play:!0,sps_sound_url:e})}).catch(e=>{console.log("出错啦!")}),o.onended=function(){chrome.storage.local.set({sps_play:!1})}},loadWhiteVoice=e=>{chrome.notifications.clear(commentList.lyricNotification),playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src","");let s=document.getElementsByTagName("source")[0];const o=`http://lemmon.cn/sounds/${e}.mp3`;s.src=o;let t=document.getElementsByTagName("audio")[0];t.loop=!0,t.load(),t.play().then(s=>{chrome.storage.local.set({sps_song:e,sps_web:"Voice",sps_play:!0,sps_sound_url:o})}).catch(e=>{console.log("出错啦!")}),t.onended=function(){chrome.storage.local.set({sps_play:!1})}},loadPodcast=e=>{const{url:s,name:o,index:t}=e;BG_BASIC.podcastIndex=t,chrome.notifications.clear(commentList.lyricNotification),playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),document.getElementsByTagName("source")[0].src=s;let n=document.getElementsByTagName("audio")[0];n.loop=!1,n.load(),n.play().then(e=>{chrome.storage.local.set({sps_song:o,sps_web:"Podcast",sps_play:!0,sps_sound_url:s})}).catch(e=>{console.log("出错啦!")}),n.onended=function(){n.pause(),BG_BASIC.M.openDB()},n.ontimeupdate=function(){handleProgress(n)}},loadSong=(e,s,o,t,n,a,l,r,c,i,p)=>{playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src","");let m,u=document.getElementsByTagName("source")[0];m=l?`${e}#t=${r},${c}`:`${e}`,u.src=m,chrome.storage.local.set({sps_song:s,sps_web:o,sps_play:!0,sps_song_id:t,sps_artist:n,sps_duration:a,sps_sound_url:`${e}`,sps_cover:i,sps_page:p},()=>{chrome.runtime.connect().postMessage({storageSet:!0})});let d=document.getElementsByTagName("audio")[0];d.loop=!0,d.load(),d.play().then(e=>{}).catch(e=>{console.log("出错啦!")}),d.onended=function(){chrome.storage.local.set({sps_play:!1})},d.ontimeupdate=function(){if(l){const e=c.split(":"),s=r.split(":"),o=60*parseInt(e[0])+parseInt(e[1]),t=60*parseInt(s[0])+parseInt(s[1]);d.currentTime>=o&&(d.currentTime=t,d.play())}handleProgress(d)},chrome.storage.sync.get("lyricShow",e=>{e.lyricShow?loadLyric(o,t,s,n,l,r,c):chrome.notifications.clear(commentList.lyricNotification)}),"qq"==o&&$.ajax({url:e,timeout:500,error:function(e,o){if(403==e.status){const e={name:s,err:403};chrome.runtime.connect().postMessage(e)}}})},loadYoutube=(e,s,o,t,n,a,l,r,c,i,p)=>{playIndex=0,player.playing&&player.stop(),document.getElementsByTagName("audio")[0].pause(),chrome.storage.local.set({sps_song:s,sps_web:o,sps_play:!0,sps_song_id:t,sps_artist:n,sps_duration:a,sps_sound_url:`${e}`,sps_cover:i,sps_page:p},()=>{chrome.runtime.connect().postMessage({storageSet:!0}),$("#loopPlayer").attr("src",e)})},loadLyric=(e,s,o,t,n,a,l)=>{let r=document.getElementsByTagName("audio")[0];songGroup[e].lyric(s).then(s=>{let c,i=0;s.lyric||"migu"!==e||(chrome.notifications.create("migu",{type:"basic",title:"咪咕音乐",message:"暂不支持歌词查看",iconUrl:"./logo.png"}),chrome.notifications.clear("migu")),s.lyric&&(c=formatLyrics(s.lyric));const p=void 0==t?`${o}`:`${o} - ${t}`;c&&c.length?chrome.notifications.create(commentList.lyricNotification,{type:"basic",title:p,message:`${c[i].c}`,iconUrl:"./logo.png",requireInteraction:!0},e=>{r.ontimeupdate=function(){if(n){const e=l.split(":"),s=a.split(":"),o=60*parseInt(e[0])+parseInt(e[1]),t=60*parseInt(s[0])+parseInt(s[1]);r.currentTime>=o&&(r.currentTime=t,i=0,r.play())}handleProgress(r),0==r.currentTime&&(i=0),i<c.length&&r.currentTime.toFixed(3)>=parseFloat(c[i].t)&&(++i,chrome.notifications.update(commentList.lyricNotification,{type:"basic",title:p,message:`${c[i-1].c}`,iconUrl:"./logo.png",requireInteraction:!0},e=>{}))}}):chrome.notifications.create(commentList.lyricNotification,{type:"basic",title:`${o} - ${t}`,message:"暂无歌词",iconUrl:"./logo.png",requireInteraction:!1})})},formatLyrics=e=>{const s=new Array;return e.split("\n").map((e,o)=>{const t=e.substring(e.indexOf("[")+1,e.indexOf("]")),n=(60*t.split(":")[0]+parseFloat(t.split(":")[1])).toFixed(3);parseFloat(n)&&s.push({t:n,c:e.substring(e.indexOf("]")+1,e.length)})}),s},loadM3u8=(e,s)=>{chrome.notifications.clear(commentList.lyricNotification),document.getElementsByTagName("audio")[0].pause(),$("#loopPlayer").attr("src",""),player.play(e),chrome.storage.local.set({sps_song:s,sps_web:"fm",sps_play:!0,m3u8:e,sps_sound_url:e})},loadRadio=(e,s)=>{playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),document.getElementsByTagName("source")[0].src=e;let o=document.getElementsByTagName("audio")[0];o.load(),o.play().then(o=>{chrome.storage.local.set({sps_song:s,sps_web:"fm",sps_play:!0,sps_sound_url:e})}).catch(e=>{})};function shuffle(e){for(var s=e.length,o=0;o<s-1;o++){var t=Math.floor(Math.random()*(s-o)),n=e[t];e[t]=e[s-o-1],e[s-o-1]=n}return e}const loadPlayList=e=>{playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),chrome.storage.sync.get("likeList",function(s){const o=[];s.likeList&&s.likeList.length&&s.likeList.map(e=>{e.sps_web&&e.sps_web!=commentList.unableCollect&&o.push(e)}),chrome.storage.sync.set({likeList:o},()=>{let s=o;if((s=e?shuffle(o):o)&&s.length){const e=()=>{songGroup[s[playIndex].sps_web].song(s[playIndex].sps_song_id).then(t=>{if(t){document.getElementsByTagName("source")[0].src=t;let n=document.getElementsByTagName("audio")[0],a=s.length-playDisAbleNum;n.loop=1===a,n.load(),n.play().then(e=>{chrome.storage.local.set({sps_song:s[playIndex].sps_song,sps_web:s[playIndex].sps_web,sps_play:!0,sps_song_id:s[playIndex].sps_song_id,sps_artist:s[playIndex].sps_artist,sps_sound_url:t,sps_cover:s[playIndex].sps_cover?s[playIndex].sps_cover:"",sps_page:s[playIndex].sps_page?s[playIndex].sps_page:""},()=>{chrome.runtime.connect().postMessage({storageSet:!0})})}).catch(o=>{chrome.runtime.connect().postMessage({url:`歌曲${s[playIndex].sps_song}播放链接出现问题，已跳过播放`}),n.pause(),s.length>1&&(s[++playIndex]||(playIndex=0),e())}),n.ontimeupdate=function(){handleProgress(n)},n.onended=function(){n.pause(),o[++playIndex]||(playIndex=0),e()},chrome.storage.sync.get("lyricShow",e=>{e.lyricShow?loadLyric(o[playIndex].sps_web,o[playIndex].sps_song_id,o[playIndex].sps_song,o[playIndex].sps_artist):chrome.notifications.clear(commentList.lyricNotification)})}else chrome.runtime.connect().postMessage({url:`${s[playIndex].sps_song}播放链接出现问题,已跳过播放`}),s.length>1&&(s[playIndex++]||(playIndex=0),e()),++playDisAbleNum})};e()}else chrome.runtime.connect().postMessage({url:"收藏歌曲后，可点击CD图标循环播放列表"})})})},loadTopPlayList=()=>{playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),chrome.storage.local.get("topPlayList",function(e){const s=e.topPlayList;if(s&&s.length){const e=()=>{songGroup[s[playIndex].sps_web].song(s[playIndex].sps_song_id).then(o=>{if(o){document.getElementsByTagName("source")[0].src=o;let t=document.getElementsByTagName("audio")[0],n=s.length-playDisAbleNum;t.loop=1===n,t.load(),t.play().then(e=>{chrome.storage.local.set({sps_song:s[playIndex].sps_song,sps_web:s[playIndex].sps_web,sps_play:!0,sps_song_id:s[playIndex].sps_song_id,sps_artist:s[playIndex].sps_artist,sps_sound_url:o,sps_cover:s[playIndex].sps_cover?s[playIndex].sps_cover:"",sps_page:s[playIndex].sps_page?s[playIndex].sps_page:""},()=>{chrome.runtime.connect().postMessage({storageSet:!0})})}).catch(o=>{chrome.runtime.connect().postMessage({url:`歌曲${s[playIndex].sps_song}播放链接出现问题，已跳过播放`}),t.pause(),s.length>1&&(s[++playIndex]||(playIndex=0),e())}),t.ontimeupdate=function(){handleProgress(t)},t.onended=function(){t.pause(),s[++playIndex]||(playIndex=0),e()},chrome.storage.sync.get("lyricShow",e=>{e.lyricShow?loadLyric(s[playIndex].sps_web,s[playIndex].sps_song_id,s[playIndex].sps_song,s[playIndex].sps_artist):chrome.notifications.clear(commentList.lyricNotification)})}else chrome.runtime.connect().postMessage({url:`${s[playIndex].sps_song}播放链接出现问题,已跳过播放`}),s.length>1&&(s[playIndex++]||(playIndex=0),e()),++playDisAbleNum})};e()}else chrome.runtime.connect().postMessage({url:"暂无可播放歌曲"})})},songGroup={netease:NetEase,xiami:XiaMi,qq:QQ,youtube:YouTube,migu:MiGu},handleStop=()=>{chrome.storage.local.get(null,function(e){let s=document.getElementsByTagName("audio")[0];if(player.playing)return player.stop(),chrome.storage.local.set({sps_play:!1,last_paused:"m3u8"}),void chrome.browserAction.setBadgeText({text:""});s.paused?player.playing||"m3u8"!==e.last_paused?"youtube"===e.sps_web?($("#loopPlayer").attr("src",""),chrome.browserAction.setBadgeText({text:""}),chrome.storage.local.set({sps_play:!1})):s.paused&&"audio"===e.last_paused&&e.sps_web&&"youtube"!==e.sps_web?($("#loopPlayer").attr("src",""),chrome.browserAction.setBadgeText({text:""}),$("source").attr("src")||($("source").attr("src",e.sps_sound_url),s.load()),s.play().then(e=>{chrome.storage.local.set({sps_play:!0}),chrome.browserAction.setBadgeText({text:"▶"}),chrome.browserAction.setBadgeBackgroundColor({color:"#277eae"})}),s.onended=function(){chrome.storage.local.set({sps_play:!1})},s.ontimeupdate=function(){handleProgress(s)}):($("#loopPlayer").attr("src",""),chrome.browserAction.setBadgeText({text:""}),chrome.storage.local.set({sps_play:!1})):chrome.storage.local.get("m3u8",function(e){player.play(e.m3u8),chrome.storage.local.set({sps_play:!0}),chrome.browserAction.setBadgeText({text:"▶"}),chrome.browserAction.setBadgeBackgroundColor({color:"#277eae"})}):(s.pause(),chrome.storage.local.set({sps_play:!1,last_paused:"audio"}),chrome.browserAction.setBadgeText({text:""}))})};function randomString(e,s){return Array.apply(null,{length:s}).map(()=>e[Math.floor(Math.random()*e.length)]).join("")}function hack_referer_header(e){const s=randomString("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKMNOPQRSTUVWXYZ\\/+",176)+":"+(new Date).getTime(),o=randomString("0123456789abcdefghijklmnopqrstuvwxyz",32),t=`JSESSIONID-WYYY=${s}; _iuqxldmzr_=32; _ntes_nnid=${o},${(new Date).getTime()}; _ntes_nuid=${o}`;var n="";-1!=e.url.indexOf("://music.163.com/")&&(n="http://music.163.com/"),-1!=e.url.indexOf(".xiami.com/")&&(n="http://m.xiami.com/"),-1==e.url.indexOf("y.qq.com/")&&-1==e.url.indexOf("qqmusic.qq.com/")&&-1==e.url.indexOf("music.qq.com/")&&-1==e.url.indexOf("imgcache.qq.com/")||(n="http://y.qq.com/"),-1!==e.url.indexOf(".migu.cn")&&(n="http://music.migu.cn/v3/music/player/audio?from=migu"),-1!==e.url.indexOf("m.music.migu.cn")&&(n="https://m.music.migu.cn/");for(var a=!1,l=e.requestHeaders,r={},c=[],i=0,p=l.length;i<p;++i)"Referer"==l[i].name&&""!=n&&(l[i].value=n,a=!0),c.push(l[i].name);return c.includes("Cookie")||-1==e.url.indexOf("://music.163.com/")||l.push({name:"Cookie",value:t}),a||""==n||l.push({name:"Referer",value:n}),r.requestHeaders=l,r}chrome.runtime.onConnect.addListener(e=>{e.onMessage.addListener(e=>{try{if("stop"==e)handleStop();else if("loop"==e){let e=document.getElementsByTagName("audio")[0];e.loop?e.loop=!1:e.loop=!0}else if(e.type===commentList.local)loadLocalSong(e.url,e.name);else if(e.type===commentList.whitevoice)loadWhiteVoice(e.name);else if(e.id&&e.radio)loadFM(e.id,e.radio);else if(e.m3u8&&e.radio)loadM3u8(e.m3u8,e.radio);else if("itunes"===e.type)loadPodcast(e);else if(e.url&&e.name)loadM3u8(e.url,e.name);else if(e.playlist)loadPlayList(e.random);else if(e.topPlay)playIndex=0,player.playing&&player.stop(),$("#loopPlayer").attr("src",""),chrome.storage.local.get("topPlayList",function(e){const s=e.topPlayList;if(s&&s.length){const e=()=>{songGroup[s[playIndex].sps_web].song(s[playIndex].sps_song_id).then(o=>{if(o){document.getElementsByTagName("source")[0].src=o;let t=document.getElementsByTagName("audio")[0],n=s.length-playDisAbleNum;t.loop=1===n,t.load(),t.play().then(e=>{chrome.storage.local.set({sps_song:s[playIndex].sps_song,sps_web:s[playIndex].sps_web,sps_play:!0,sps_song_id:s[playIndex].sps_song_id,sps_artist:s[playIndex].sps_artist,sps_sound_url:o,sps_cover:s[playIndex].sps_cover?s[playIndex].sps_cover:"",sps_page:s[playIndex].sps_page?s[playIndex].sps_page:""},()=>{chrome.runtime.connect().postMessage({storageSet:!0})})}).catch(o=>{chrome.runtime.connect().postMessage({url:`歌曲${s[playIndex].sps_song}播放链接出现问题，已跳过播放`}),t.pause(),s.length>1&&(s[++playIndex]||(playIndex=0),e())}),t.ontimeupdate=function(){handleProgress(t)},t.onended=function(){t.pause(),s[++playIndex]||(playIndex=0),e()},chrome.storage.sync.get("lyricShow",e=>{e.lyricShow?loadLyric(s[playIndex].sps_web,s[playIndex].sps_song_id,s[playIndex].sps_song,s[playIndex].sps_artist):chrome.notifications.clear(commentList.lyricNotification)})}else chrome.runtime.connect().postMessage({url:`${s[playIndex].sps_song}播放链接出现问题,已跳过播放`}),s.length>1&&(s[playIndex++]||(playIndex=0),e()),++playDisAbleNum})};e()}else chrome.runtime.connect().postMessage({url:"暂无可播放歌曲"})});else if(e.position){let s=document.getElementsByTagName("audio")[0];4===s.readyState&&(s.pause(),s.currentTime=s.duration*e.position,s.play().then(()=>{chrome.storage.local.set({sps_play:!0})}))}else if(e.web&&"youtube"===e.web){const{id:s,web:o,name:t,artist:n,range:a,duration:l,sps_start:r,sps_end:c,cover:i,page:p}=e;songGroup.youtube.song(s).then(e=>{loadYoutube(e,t,o,s,n,l,0,0,0,i,p)})}else{const{id:s,web:o,name:t,artist:n,range:a,duration:l,sps_start:r,sps_end:c,cover:i,page:p}=e;songGroup[o].song(s).then(e=>{loadSong(e,t,o,s,n,l,a,r,c,i,p),e||chrome.runtime.connect().postMessage({url:`${t}无法播放，请查看其它源或从收藏删除`})})}}catch(e){}})});const extraInfoSpec=["blocking","requestHeaders"];chrome.webRequest.OnBeforeSendHeadersOptions.hasOwnProperty("EXTRA_HEADERS")&&extraInfoSpec.push("extraHeaders"),chrome.webRequest.onBeforeSendHeaders.addListener(hack_referer_header,{urls:["*://music.163.com/*","*://*.xiami.com/*","*://*.qq.com/*","*://*.migu.cn/*"]},extraInfoSpec),chrome.commands.onCommand.addListener(function(e){if("base"===e)handleStop();else if("next"===e){let e=document.getElementsByTagName("audio")[0];4===e.readyState&&(e.pause(),e.currentTime=e.duration-1e-4,e.play().then(()=>{chrome.storage.local.set({sps_play:!0})}))}else"mv"===e?chrome.storage.local.get(null,function(e){if(e.sps_web&&"Voice"!==e.sps_web&&"fm"!==e.sps_web)if("youtube"===e.sps_web)window.open(`https://www.youtube.com/watch?v=${e.sps_song_id}`,"_blank");else{const s=e.sps_song,o=e.sps_artist;chrome.storage.sync.get({customChannel:"youtube"},function(e){"youtube"===e.customChannel?window.open(`https://www.youtube.com/results?search_query=${s} ${o}`,"_blank"):window.open(`https://search.bilibili.com/all?keyword=${s} ${o}`,"_blank")})}else chrome.runtime.connect().postMessage({url:"MV功能只支持歌曲播放"})}):"page"===e&&chrome.storage.local.get(null,function(e){const s=e.sps_web,o=e.sps_page;switch(s){case"netease":o?window.open(`https://music.163.com/#/song?id=${o}`,"_blank"):chrome.runtime.connect().postMessage({url:"重新收藏此单曲,即可使用网页功能"});break;case"qq":o?window.open(`https://y.qq.com/n/yqq/song/${o}.html`,"_blank"):chrome.runtime.connect().postMessage({url:"重新收藏此单曲,即可使用网页功能"});break;case"xiami":o?window.open(`https://www.xiami.com/song/${o}`,"_blank"):chrome.runtime.connect().postMessage({url:"重新收藏此单曲,即可使用网页功能"});break;case"youtube":o&&window.open(`https://www.youtube.com/watch?v=${o}`,"_blank");break;case"migu":o&&window.open(`http://music.migu.cn/v3/music/song/${o}`,"_blank");break;default:chrome.runtime.connect().postMessage({url:"新开页面功能只支持歌曲播放"})}})}),chrome.runtime.onInstalled.addListener(function(e){const s=e.previousVersion?parseInt(e.previousVersion.split(".").join("")):null;("install"===e.reason||"update"===e.reason&&s<=223)&&chrome.storage.sync.set({install:!0})});const volumeSet=function(){chrome.storage.local.get(null,function(e){let s=document.getElementsByTagName("audio")[0];e.hasOwnProperty("volume")?s.volume=e.volume:(chrome.storage.local.set({volume:.8}),s.volume=.8)})};chrome.storage.local.get(null,function(e){let s=document.getElementsByTagName("audio")[0];e.hasOwnProperty("volume")?s.volume=e.volume:(chrome.storage.local.set({volume:.8}),s.volume=.8)}),chrome.storage.onChanged.addListener((e,s)=>{if(e.hasOwnProperty("volume")){document.getElementsByTagName("audio")[0].volume=e.volume.newValue}}),chrome.storage.local.set({sps_play:!1},e=>{chrome.browserAction.setBadgeText({text:""})});