const MiConfig={listUrl:"http://api.xiami.com/web",songUrl:"http://emumo.xiami.com/song/playlist/id/{replace}/object_name/default/object_id/0/cat/json",lyricUrl:""};class XiaMiSong{caesar(a){for(var i=a[0],e=Math.floor(a.slice(1).length/i),r=a.slice(1).length%i,t=[],s=0;s<r;s++){var c=a.slice(s*(e+1)+1,(s+1)*(e+1)+1);t.push(c)}for(s=0;s<i-r;s++){c=a.slice((e+1)*r).slice(s*e+1,(s+1)*e+1);t.push(c)}var l=[];for(s=0;s<e;s++)for(var o=0;o<i;o++)l.push(t[o][s]);for(s=0;s<r;s++)l.push(t[s].slice(-1));return unescape(l.join("")).replace(/\^/g,"0")}}class XiaMiReq extends XiaMiSong{constructor(a){super(a)}async list(a,i){return await new Promise((e,r)=>{$.ajax({url:"https://www.xiami.com/api/search/searchSongs",success:t=>{t.hasOwnProperty("rgv587_flag")?(e([]),$(".alert").html('请打开 <a href="https://www.xiami.com/search?key=song" target="_blank">xiaimi</a> 处理滑块校验').addClass("show"),setTimeout(()=>{$(".alert").removeClass("show")},4e3)):chrome.cookies.get({url:"https://www.xiami.com",name:"xm_sg_tk"},t=>{const s=t.value,c={pagingVO:{page:"1",pageSize:i},key:a},l=JSON.stringify(c),o=s.split("_")[0]+"_xmMain_/api/search/searchSongs_"+l,n=MD5(o);$.ajax({url:`https://www.xiami.com/api/search/searchSongs?_q={"pagingVO":{"page":"1","pageSize":${i}},"key":"${a}"}&_s=${n}`,success:a=>{let i,r=[];try{i=a.result.data}catch(e){i=JSON.parse(a).result.data}i.songs.map((a,i)=>{r[i]={name:a.songName,id:a.songId,artists:[a.artistName],album:a.albumName,xiami:a.needPayFlag,duration:"xiami",cover:a.albumLogo?a.albumLogo:"",page:a.songStringId}}),e(r)},error:a=>{console.log(a),r(a)}})})},error:a=>{console.log("err:",a),r(a)}})})}async detail(a){const i=MiConfig.songUrl.replace("{replace}",a);return await new Promise((a,e)=>{$.get(i,i=>{let e;try{e=i.data}catch(a){e=JSON.parse(i).data}const r=e.trackList[0];MiConfig.lyricUrl="",e.trackList&&e.trackList[0]&&(MiConfig.lyricUrl="http:"+e.trackList[0].lyric_url),a(r)})})}async song(a){const i=MiConfig.songUrl.replace("{replace}",a);return await new Promise((a,e)=>{$.get(i,i=>{let e;try{e=i.data}catch(a){e=JSON.parse(i).data}MiConfig.lyricUrl="";let r=null;if(e.trackList&&e.trackList[0]){const a=e.trackList[0].location;r="http:"+this.caesar(a),MiConfig.lyricUrl="http:"+e.trackList[0].lyric_url}a(r)})})}async lyric(a){return await new Promise((a,i)=>{let e={lyric:""};MiConfig.lyricUrl?$.get(MiConfig.lyricUrl,i=>{a(e={lyric:i})}):a(e)})}}const XiaMi=new XiaMiReq;